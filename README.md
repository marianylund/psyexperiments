# JSP

This is a private repository for running experiments on the web using jspsych library.

## Table of Contents

- [Website code](#website-code)
- [Data parsing (python)](#data-parsing-python)
- [NREC server](#nrec-server)
- [Future work](#future-work)
- [License](#license)
- [Contact](#contact)

## Website code

Prerequisites:

- Node v18.18.2 https://nodejs.org/en/blog/release/v18.18.2
- Python

### Backend

It handles the server-side logic and API endpoints. Currently, listens to requests on the server from frontend and once experiment raw data is sent, it uploads the JSON to OSF. Which OSF project it uploads to depends on the values defined in .env:

(!) Important: Requires a file called .env inside backend folder to run correctly with two variables:

```
OSF_API_TOKEN = [insert long token]
OSF_RESOURCE_ID = [insert some id]
```

Get token from https://osf.io/settings/tokens, resource id can be found in the address when you go to the project: https://osf.io/some_id_here/ instead of `some_id_here`. Those are secret variables, therefore not added to the repo.
First time running project, remember to install packages by running `npm install`.
Run `npm run start` to start running the backend, when testing.

### Frontend

The frontend is built using [jspsych builder](https://github.com/bjoluc/jspsych-builder).

Uses a new [video-several-keyboard-responses](https://github.com/jspsych/jspsych-contrib/tree/main/packages/plugin-video-several-keyboard-responses) plugin for the video experiment.

Run `npm run start experiment` to start running the specific js file in this case `experiment.js`, when testing. Remember to run `npm build` the first time setting up the project.

## Data parsing (python)

Script used to parse .json data that is generated by jspsych library. Takes in a path to zipped (or unzipped) folder that contains .json files from jspsych library and saves the data to two .csv file: short version containing all results and long version with the data only from video responses

### To install:

1. Download and install [python](https://www.python.org/downloads/). Tested with Python 3.12.0
2. In console go into the `pythonDataParsing` folder and run `pip install -r requirements.txt` to install other requirements needed to run the code.

### To run:

1. Open `parse_raw_jspsych_data.py` and edit parameters at the start of the file, especially `ZIP_PATH` that takes in the path to the folder containing .json files.
2. In a console run `python parse_raw_jspsych_data.py` inside the same folder as the file.

## NREC server

Server has read-access to this repository to get the code, build and serve it. Currently, `158.37.63.194` should be running at all times.

### Access (SSH)

If it is the first time accessing the server, you need to create SSH key on your machine and add it on the NREC website, following [this](https://docs.nrec.no/ssh.html) guide. Otherwise:

1. Connect to UiO VPN
2. In the console of your choice run `ssh -i ~/.ssh/nrec ubuntu@158.37.63.194`, where `~/.ssh/nrec` is the path to the SSH key on your machine.
3. (Ignore for now) If you have set up that only logged-in users can join the server youÂ´ll need to alternatively run `ssh -J username@login.uio.no -i ~/.ssh/nrec ubuntu@158.37.63.194`, where `username` is your UiO username.

### Update

So, you have added changes to the repo and want to update the server, first [access the server](#access-ssh) through ssh.

#### Manual

1. Go into the repo folder and run `git pull` to get the changes
2. Go into the frontend folder, run `npm run install` if new libraries were added
3. Run `npm run build` where ? is the name of the js script describing the experiment is.
4. If it is the first time the new experiment is added, add location/ as in [example](https://gist.github.com/leommoore/2701379) to `sites-enabled/JSP` file and

```
root /var/www/experiment;
index index.html index.htm;
```

5. If you have built this experiment before, run `sudo rm /var/www/experiment/ -r` to delete it
6. Move dist folder to `/var/www/experiment/` by running `sudo mv experiment /var/www` inside the dist folder
7. To update backend run build and install inside backend folder
8. Might need to run `sudo systemctl restart nginx` to restart nginx

#### Semi-automatic

TODO: Add a bash script to run the commands described in [manual](#manual) automatically.

### Set-up a new one

In case the server needs to be set up again, otherwise feel free to ignore this section. Here are some steps in broad terms needed to achieve that:

1. Create SSH key on your machine and add it to NREC, following [this](https://docs.nrec.no/ssh.html) guide.
2. Following [this](https://docs.nrec.no/create-virtual-machine.html) create the server:
   - Choose GOLD Ubuntu 22.04 LTS
   - DUAL network protocols (UiO VPN does not create IPv6, only IPv4)
3. Set up Security Group as described [here](https://docs.nrec.no/security-groups.html#id12) with SSH and HTTPS open from all IP addresses.
4. [Access the server](#access-ssh)
5. Set up git read access to this repo and clone it
6. Install nginx and allow it to pass the firewall, [guide](https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-22-04)
   - Go to `/etc/nginx/sites-enabled` and create file named JSP
   - Copy text from [here](https://pm2.keymetrics.io/docs/tutorials/pm2-nginx-production-setup), change `server_name 158.37.63.194` and listen to 80, Remove cert options
   - `sudo systemctl restart nginx` to restart nginx
7. Install node, [guide](https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-20-04#option-3-installing-node-using-the-node-version-manager)
8. Install pm2 `npm install pm2 -g` to automatically run and restart node
   - Add file to backend as in the [example](https://pm2.keymetrics.io/docs/usage/environment/)
     - Run `pm2 start ecosystem.config.js --env production` and `pm2 save`
   - To check health: `pm2 status` or `pm2 log`
9. Build and serve as described in [Update](#update) server section.

## Future work

- [ ] Set-up domain name on the server
- [ ] Implement UiO footer and header on the frontpage
- [ ] Add https certificate using https://certbot.eff.org/, right now we only have http
- [ ] Move frontend to public git repo, there is nothing secret
- [ ] Add more safety in the `index.js` in `backend` code to check body size of requests and query length
- [ ] (Optional to make life easier) Set-up git hooks, so when there is an update, server re-builds and moves changes automatically

## License

[Insert license information here]

## Contact

For any questions or inquiries, please contact [thomasschubert](https://github.com/thomasschubert).
